<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI PDF Summarizer — Final</title>

  <!-- jsPDF for client PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --accent1:#8b5cf6; --accent2:#06b6d4; --muted:#9fb2d9;
      --card: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Arial;padding:22px;
      color:#eaf2ff; background: linear-gradient(135deg,#071032 0%, #0b1220 50%, #071a2a 100%);
      background-size: 300% 300%; animation: bgShift 18s ease infinite;
    }
    @keyframes bgShift {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:22px;
      background: linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .card{background:var(--card);backdrop-filter:blur(8px);border-radius:14px;padding:16px;margin-top:16px;box-shadow:0 10px 30px rgba(2,6,23,0.5)}
    .upload{border:2px dashed rgba(255,255,255,0.06);padding:18px;border-radius:12px;text-align:center;cursor:pointer}
    .upload.drag{border-color:rgba(139,92,246,0.6);transform:scale(1.01)}
    input[type=file]{display:none}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .result{margin-top:12px;padding:14px;border-radius:10px;min-height:140px;white-space:pre-wrap;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-left:4px solid rgba(139,92,246,0.16)}
    .meta{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
    .progress{height:10px;background:rgba(255,255,255,0.02);border-radius:10px;margin-top:12px;overflow:hidden;display:none}
    .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .3s}
    .history-wrap{position:fixed;right:18px;top:80px;width:340px;max-height:70vh;transform:translateX(420px);transition:transform .45s;z-index:1200}
    .history-wrap.open{transform:translateX(0)}
    .history-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 18px 40px rgba(2,6,23,0.25);height:100%;overflow:auto}
    .history-item{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .orb{position:fixed;right:34px;bottom:40px;width:70px;height:70px;border-radius:50%;z-index:1500;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transform:scale(.9);transition:all .28s}
    .orb.show{opacity:1;transform:scale(1)}
    .orb-core{width:70px;height:70px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#8b5cf6,#7c3aed);box-shadow:0 0 60px #7c3aed}
    .orb-speech{position:absolute;bottom:92px;right:0;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#ffffffee,#f7fbff);color:#071032;box-shadow:0 12px 40px rgba(7,12,40,0.08);opacity:0;transform:translateY(6px);transition:all .2s}
    .orb-speech.show{opacity:1;transform:translateY(0)}
    .small{font-size:13px;color:var(--muted)}
    @media(max-width:900px){ .history-wrap{display:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>✨ AI PDF Summarizer — Final</h1>
        <div class="sub">Polished frontend. Works with your Render backend — no backend code changes required.</div>
      </div>
      <div>
        <button id="toggleHistory" class="ghost small">📜 History</button>
      </div>
    </header>

    <!-- Upload card -->
    <div class="card">
      <div id="uploadArea" class="upload">
        <div style="font-weight:600">🔽 Drag & drop PDF here or click to choose</div>
        <div class="small" style="margin-top:6px">Recommended &lt; 16 MB</div>
        <input id="fileInput" type="file" accept="application/pdf" />
      </div>

      <div class="controls">
        <label class="small">Preview sentences</label>
        <input id="lenRange" type="range" min="1" max="8" value="3" />
        <div class="small">•</div>
        <button id="summBtn" class="btn">⚡ Summarize</button>
        <button id="shortBtn" class="ghost">✂️ Shorten</button>
        <button id="expandBtn" class="ghost">🔍 Expand</button>
        <button id="kwBtn" class="ghost">🔎 Keywords</button>
      </div>

      <div id="warn" class="small" style="color:#ffb4b4;margin-top:8px;display:none"></div>
      <div id="progress" class="progress"><div></div></div>
    </div>

    <!-- Result card -->
    <div class="card">
      <h3 style="margin:0">🧠 Summary</h3>
      <div id="result" class="result">No summary yet.</div>
      <div class="meta" id="meta" style="display:none">
        <div class="chip">Words: <span id="wc">0</span></div>
        <div class="chip">Sentences: <span id="sc">0</span></div>
        <div class="chip">Read: <span id="rt">0</span> min</div>
        <div class="chip">Keywords: <span id="kws">—</span></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="speakBtn" class="ghost">🗣 Play</button>
        <button id="stopBtn" class="ghost">🛑 Stop</button>
        <button id="copyBtn" class="ghost">📋 Copy</button>
        <button id="downTxt" class="ghost">⬇️ TXT</button>
        <button id="downPdf" class="ghost">⬇️ PDF</button>
      </div>
    </div>

    <footer style="margin-top:12px" class="small">Tip: Use the History panel to re-open previous summaries. Backend URL is pre-set.</footer>
  </div>

  <!-- Sliding history -->
  <div class="history-wrap" id="historyWrap" aria-hidden="true">
    <div class="history-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>📜 Summary History</strong>
        <div style="display:flex;gap:8px">
          <button id="exportHist" class="ghost small">Export</button>
          <button id="importHist" class="ghost small">Import</button>
          <button id="clearHist" class="ghost small">Clear</button>
        </div>
      </div>
      <div id="historyList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Orb -->
  <div id="orb" class="orb" aria-hidden="true">
    <div class="orb-core"></div>
    <div id="orbSpeech" class="orb-speech"></div>
  </div>

  <script>
  // ====== CONFIG: set your backend URL here (no trailing slash) ======
  const BACKEND_URL = "https://ai-backend-3-aepo.onrender.com";

  // ====== STATE & REFS ======
  let lastFull = "";                      // store the last successful full summary
  let historyArr = JSON.parse(localStorage.getItem('aiSummHistory')||'[]');
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const summBtn = document.getElementById('summBtn');
  const progress = document.getElementById('progress');
  const progressInner = progress.querySelector('div');
  const warn = document.getElementById('warn');
  const resultEl = document.getElementById('result');
  const meta = document.getElementById('meta');
  const wc = document.getElementById('wc'), sc = document.getElementById('sc'), rt = document.getElementById('rt'), kws = document.getElementById('kws');
  const lenRange = document.getElementById('lenRange');
  const shortBtn = document.getElementById('shortBtn'), expandBtn = document.getElementById('expandBtn'), kwBtn = document.getElementById('kwBtn');
  const speakBtn = document.getElementById('speakBtn'), stopBtn = document.getElementById('stopBtn');
  const copyBtn = document.getElementById('copyBtn'), downTxt = document.getElementById('downTxt'), downPdf = document.getElementById('downPdf');
  const toggleHistory = document.getElementById('toggleHistory'), historyWrap = document.getElementById('historyWrap'), historyList = document.getElementById('historyList');
  const exportHist = document.getElementById('exportHist'), importHist = document.getElementById('importHist'), clearHist = document.getElementById('clearHist');
  const orb = document.getElementById('orb'), orbSpeech = document.getElementById('orbSpeech');

  const synth = window.speechSynthesis;
  let tts = null;

  // ====== UTIL ======
  function showWarn(msg){ warn.style.display = msg ? 'block' : 'none'; warn.textContent = msg || ''; }
  function setProgress(p){ progress.style.display = 'block'; progressInner.style.width = p + '%'; if(p>=100) setTimeout(()=>progress.style.display='none', 400); }
  function showOrb(msg){ orb.classList.add('show'); if(msg) orbSpeak(msg); }
  function hideOrb(){ orb.classList.remove('show'); orbSpeech.classList.remove('show'); }
  function orbSpeak(txt, speed=24){
    orbSpeech.textContent=''; orbSpeech.classList.add('show');
    let i=0; const iv = setInterval(()=>{ orbSpeech.textContent += txt[i]||''; i++; if(i>txt.length) clearInterval(iv); }, speed);
  }
  function splitSentences(text){ return (text || '').split(/(?<=[.?!])\s+/).filter(Boolean); }
  function topKeywords(text, n=6){
    const words = (text || '').toLowerCase().match(/\b[a-z]{3,}\b/g) || [];
    const stop = new Set(['this','that','their','there','with','about','have','which','from','will','would','could','your','also','they','then']);
    const freq = {};
    words.forEach(w=>{ if(!stop.has(w)) freq[w]=(freq[w]||0)+1; });
    return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
  }
  function updateMeta(summary){
    if(!summary){ meta.style.display='none'; return; }
    const words = (summary.trim().split(/\s+/).filter(Boolean)).length;
    const sents = splitSentences(summary).length;
    wc.textContent = words; sc.textContent = sents; rt.textContent = Math.max(1, Math.round(words/200));
    const kwsArr = topKeywords(summary,6); kws.textContent = kwsArr.join(', ') || '—';
    meta.style.display = 'flex';
  }

  // typing effect (word-wise)
  function typeWrite(el, text, wpm=300){
    el.textContent=''; const words = (text || '').split(/\s+/); let i=0;
    const ms = Math.max(6, Math.round(60000/wpm)); const iv = setInterval(()=>{ el.textContent += (i? ' ':'') + (words[i]||''); i++; if(i>=words.length) clearInterval(iv); }, ms);
  }

  // ====== HISTORY ======
  function saveHistory(){ localStorage.setItem('aiSummHistory', JSON.stringify(historyArr)); }
  function renderHistory(){
    historyList.innerHTML = '';
    if(historyArr.length === 0){ historyList.innerHTML = '<div class="small" style="color:var(--muted)">No history yet</div>'; return; }
    historyArr.forEach((h, i) => {
      const row = document.createElement('div'); row.className = 'history-item';
      const left = document.createElement('div'); left.innerHTML = `<strong>${h.name || 'Untitled'}</strong><div class="small" style="color:var(--muted)">${h.time || ''}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      const viewBtn = document.createElement('button'); viewBtn.className='ghost small'; viewBtn.textContent='View';
      const dlBtn = document.createElement('button'); dlBtn.className='ghost small'; dlBtn.textContent='DL';
      viewBtn.onclick = ()=>{ lastFull = h.summary || ''; displaySummary(lastFull); updateMeta(lastFull); historyWrap.classList.remove('open'); };
      dlBtn.onclick = ()=>{ downloadPDF(h.name || 'summary', h.summary || ''); };
      right.appendChild(viewBtn); right.appendChild(dlBtn);
      row.appendChild(left); row.appendChild(right);
      historyList.appendChild(row);
    });
  }
  function addHistory(name, summary){
    historyArr.unshift({ id: Date.now(), name: name || 'Untitled', summary: summary || '', time: new Date().toLocaleString() });
    if(historyArr.length > 80) historyArr.pop();
    saveHistory(); renderHistory();
  }

  // ====== CORE: send file to backend ======
  async function summarizeFile(file){
    showWarn('');
    if(!file) return showWarn('Please choose a PDF.');
    if(file.size > 32 * 1024 * 1024) showWarn('Large file — may be slow (recommended <32MB).');

    showOrb(); orbSpeak("Analyzing your document...");
    setProgress(8);
    let p = 8; const tracker = setInterval(()=>{ p = Math.min(92, p + Math.random()*6 + 4); setProgress(p); }, 600);

    try{
      const fd = new FormData(); fd.append('file', file);
      const res = await fetch(BACKEND_URL + '/summarize', { method: 'POST', body: fd });
      clearInterval(tracker); setProgress(92);
      if(!res.ok){
        const txt = await res.text();
        hideOrb(); setProgress(0);
        return showWarn('Server error: ' + res.status + (txt ? ' — ' + txt : ''));
      }
      const j = await res.json();
      hideOrb(); setProgress(100);
      if(j.error) return showWarn('Backend: ' + j.error);
      const summary = (j.summary || j.result || '').trim();
      if(!summary){ displaySummary('No summary generated.'); updateMeta(''); addHistory(file.name, ''); return; }
      lastFull = summary;
      addHistory(file.name, summary);
      typeWrite(resultEl, summary, 200);
      updateMeta(summary);
      orbSpeak("Summary ready!");
      setTimeout(()=>orbSpeech.classList.remove('show'), 1600);
    }catch(err){
      clearInterval(tracker); hideOrb(); setProgress(0);
      showWarn('Request failed: ' + (err.message || err));
    }
  }
  function displaySummary(txt){ resultEl.textContent = txt || ''; updateMeta(txt || ''); }

  // ====== Shorten / Expand / Keywords ======
  document.getElementById('shortBtn').onclick = ()=> {
    if(!lastFull) return showWarn('No summary to shorten'); showWarn('');
    const n = Math.max(1, parseInt(lenRange.value || 3));
    const s = splitSentences(lastFull).slice(0, n).join(' ');
    displaySummary(s); updateMeta(s);
  };
  document.getElementById('expandBtn').onclick = ()=> {
    if(!lastFull) return showWarn('No summary to expand'); showWarn('');
    const n = Math.max(4, parseInt(lenRange.value || 3) * 2);
    const s = splitSentences(lastFull).slice(0, n).join(' ');
    displaySummary(s); updateMeta(s);
  };
  document.getElementById('kwBtn').onclick = ()=> {
    const text = resultEl.innerText || lastFull || '';
    if(!text) return showWarn('No summary to analyze');
    showWarn('');
    const keys = topKeywords(text, 8);
    if(keys.length === 0) return showWarn('No keywords found');
    let safe = text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    keys.forEach(k=>{
      const esc = k.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');
      const re = new RegExp('\\b(' + esc + ')\\b','gi');
      safe = safe.replace(re, '<mark style="background:linear-gradient(90deg,#fff9c4,#ffd54f);padding:2px;border-radius:4px">$1</mark>');
    });
    resultEl.innerHTML = safe;
    updateMeta(text);
  };

  // ====== TTS controls ======
  speakBtn.onclick = ()=> {
    const text = resultEl.innerText || lastFull || '';
    if(!text) return showWarn('No text to read');
    showWarn('');
    if(tts){ synth.cancel(); tts = null; }
    tts = new SpeechSynthesisUtterance(text);
    tts.rate = 1; tts.pitch = 1; tts.onend = ()=>{ tts = null; };
    synth.speak(tts);
  };
  stopBtn.onclick = ()=> { if(tts) synth.cancel(); tts = null; };

  // ====== Copy / Download ======
  copyBtn.onclick = ()=> {
    const t = resultEl.innerText || lastFull || '';
    if(!t) return showWarn('No summary to copy');
    navigator.clipboard.writeText(t).then(()=>{ flash(copyBtn); }, ()=>{ showWarn('Copy failed'); });
  };
  downTxt.onclick = ()=> {
    const t = resultEl.innerText || lastFull || '';
    if(!t) return showWarn('No summary to download');
    const blob = new Blob([t], { type: 'text/plain' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (historyArr[0]?.name || 'summary') + '.txt'; a.click(); flash(downTxt);
  };
  downPdf.onclick = ()=> {
    const t = resultEl.innerText || lastFull || '';
    if(!t) return showWarn('No summary to download');
    downloadPDF((historyArr[0]?.name || 'summary'), t); flash(downPdf);
  };

  function flash(el){ el.style.transform = 'translateY(-3px)'; setTimeout(()=>el.style.transform = '', 160); }

  // ====== PDF generation (jsPDF) ======
  function downloadPDF(name, text){
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      doc.setFontSize(14); doc.text(`Summary — ${name}`, 40, 60);
      doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()} — AI PDF Summarizer`, 40, 80);
      const lines = doc.splitTextToSize(text, 520);
      doc.text(lines, 40, 110); doc.save((name || 'summary') + '.pdf');
    }catch(e){
      alert('PDF export failed: ' + (e.message || e));
    }
  }

  // ====== History export/import/clear ======
  exportHist.onclick = ()=> {
    const blob = new Blob([JSON.stringify(historyArr, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'summary-history.json'; a.click();
  };
  importHist.onclick = ()=> {
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=> {
      const f = inp.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = (ev)=> {
        try{ const arr = JSON.parse(ev.target.result); if(Array.isArray(arr)){ historyArr = arr.concat(historyArr); saveHistory(); renderHistory(); alert('Import complete'); } else alert('Invalid JSON'); }
        catch(e){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    };
    inp.click();
  };
  clearHist.onclick = ()=> { if(confirm('Clear all history?')){ historyArr = []; saveHistory(); renderHistory(); } };

  // ====== Drag & drop wiring ======
  uploadArea.addEventListener('click', ()=> fileInput.click());
  uploadArea.addEventListener('dragenter', e=>{ e.preventDefault(); uploadArea.classList.add('drag'); });
  uploadArea.addEventListener('dragover', e=> e.preventDefault());
  uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('drag'));
  uploadArea.addEventListener('drop', e=>{ e.preventDefault(); uploadArea.classList.remove('drag'); const f = e.dataTransfer.files[0]; if(f && f.type === 'application/pdf') fileInput.files = e.dataTransfer.files; else showWarn('Please drop a PDF file'); });

  fileInput.onchange = ()=> { showWarn(''); };

  // ====== Summarize button ======
  summBtn.onclick = ()=> {
    const f = fileInput.files[0];
    if(!f) return showWarn('Pick a PDF first');
    summBtn.classList.add('btn-working'); setTimeout(()=>summBtn.classList.remove('btn-working'), 1200);
    summarizeFile(f);
  };

  // ====== History panel toggle ======
  toggleHistory.onclick = ()=> { historyWrap.classList.toggle('open'); };

  // ====== helper: ping backend silently ======
  (async ()=>{ try{ await fetch(BACKEND_URL + '/'); }catch(e){} })();

  // ====== initial render / greet ======
  renderHistory(); updateMeta(''); hideOrb();
  setTimeout(()=>{ showOrb(); orbSpeak("Hello — I'm ready to summarize your PDF!"); setTimeout(()=>hideOrb(), 2600); }, 700);

  // ====== ensure save on unload ======
  window.addEventListener('beforeunload', ()=> saveHistory());

  // ====== helper functions at bottom to avoid hoisting confusion ======
  function saveHistory(){ localStorage.setItem('aiSummHistory', JSON.stringify(historyArr)); }
  function renderHistory(){ renderHistory(); } // placeholder - replaced below

  // re-define renderHistory to avoid reference confusion
  renderHistory = function(){
    historyList.innerHTML = '';
    if(historyArr.length === 0){ historyList.innerHTML = '<div class="small" style="color:var(--muted)">No history yet</div>'; return; }
    historyArr.forEach((h,i)=>{
      const row = document.createElement('div'); row.className='history-item';
      const left = document.createElement('div'); left.innerHTML = `<strong>${h.name || 'Untitled'}</strong><div class="small" style="color:var(--muted)">${h.time || ''}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      const viewBtn = document.createElement('button'); viewBtn.className='ghost small'; viewBtn.textContent='View';
      const dlBtn = document.createElement('button'); dlBtn.className='ghost small'; dlBtn.textContent='DL';
      viewBtn.onclick = ()=>{ lastFull = h.summary || ''; displaySummary(lastFull); updateMeta(lastFull); historyWrap.classList.remove('open'); };
      dlBtn.onclick = ()=>{ downloadPDF(h.name || 'summary', h.summary || ''); };
      right.appendChild(viewBtn); right.appendChild(dlBtn);
      row.appendChild(left); row.appendChild(right);
      historyList.appendChild(row);
    });
  };

  // small polyfill: ensure functions exist if above hoisting changed flow
  if(typeof renderHistory !== 'function'){
    renderHistory = function(){ historyList.innerHTML = '<div class="small" style="color:var(--muted)">No history yet</div>'; };
  }

  </script>
</body>
</html>
